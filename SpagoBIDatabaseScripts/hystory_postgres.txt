-- ##################################################################################################
-- 	Before 2.0
-- ##################################################################################################

ALTER TABLE sbi_data_set ADD COLUMN pivot_value character varying(50);
ALTER TABLE sbi_data_set ADD COLUMN pivot_row character varying(50);
ALTER TABLE sbi_data_set ADD COLUMN pivot_column character varying(50);
ALTER TABLE sbi_data_set ADD COLUMN transformer_id integer;
ALTER TABLE sbi_data_set ADD COLUMN script text;
ALTER TABLE sbi_data_set ADD COLUMN jclass_name character varying(100);
ALTER TABLE sbi_objects ADD COLUMN prof_visibility character varying(400);
ALTER TABLE sbi_parameters ADD COLUMN temporal_flag smallint NOT NULL DEFAULT 0;
ALTER TABLE sbi_geo_maps ADD COLUMN bin_id integer;
ALTER TABLE sbi_geo_maps ALTER COLUMN url DROP NOT NULL;


-- ##################################################################################################
-- 	From 2.0 
-- ##################################################################################################

ALTER TABLE sbi_audit ALTER doc_parameters TYPE text;
ALTER TABLE sbi_audit ALTER COLUMN doc_parameters SET DEFAULT NULL;

ALTER TABLE sbi_viewpoints ALTER vp_value_params TYPE text;
ALTER TABLE sbi_viewpoints ALTER COLUMN vp_value_params SET DEFAULT NULL;

ALTER TABLE sbi_remember_me ALTER parameters TYPE text;
ALTER TABLE sbi_remember_me ALTER COLUMN parameters SET DEFAULT NULL;

ALTER TABLE sbi_data_set ADD COLUMN num_rows boolean DEFAULT FALSE;

ALTER TABLE sbi_menu ADD COLUMN biobj_parameters text;

-- kpi model
CREATE SEQUENCE SBI_KPI_INSTANCE_HISTORY_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_KPI_INSTANCE_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_KPI_MODEL_INST_SEQ INCREMENT 1 START  1; 
CREATE SEQUENCE SBI_KPI_MODEL_SEQ INCREMENT 1 START  1;
CREATE SEQUENCE SBI_KPI_VALUE_SEQ INCREMENT 1 START 1 ;
CREATE SEQUENCE SBI_KPI_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_KPI_INST_PERIOD_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_KPI_MODEL_ATTR_VAL_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_KPI_MODEL_RESOURCES_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE RESOURCES_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_THRESHOLD_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_THRESHOLD_VAULE_SEQ INCREMENT 1 START  1; 
CREATE SEQUENCE SBI_KPI_PERIODICITY_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_MEASURE_UNIT_SEQ INCREMENT 1 START  1 ;

CREATE TABLE SBI_KPI_ROLE (
	id_kpi_role INTEGER NOT NULL,
	KPI_ID INTEGER NOT NULL,
	EXT_ROLE_ID INTEGER NOT NULL,
	CONSTRAINT XPKSBI_KPI_ROLE 
              PRIMARY KEY (id_kpi_role)
 ) WITHOUT OIDS;


Create table SBI_KPI (
	KPI_ID INTEGER DEFAULT nextval('SBI_KPI_SEQ')  NOT NULL ,
	ID_MEASURE_UNIT INTEGER,
	DS_ID INTEGER,
	ID_KPI_PARENT INTEGER,
	THRESHOLD_ID INTEGER,
	NAME VARCHAR (400)  NOT NULL ,
	DOCUMENT_LABEL VARCHAR (40),
	CODE VARCHAR (40),
	METRIC VARCHAR (1000),
	DESCRIPTION VARCHAR (1000),
	WEIGHT INTEGER,
	FLG_IS_FATHER Char (1),
	KPI_TYPE INTEGER,
	METRIC_SCALE_TYPE INTEGER,
	MEASURE_TYPE INTEGER,
	INTERPRETATION VARCHAR (1000),
	INPUT_ATTRIBUTES VARCHAR (1000),
	MODEL_REFERENCE VARCHAR (255),
	TARGET_AUDIENCE VARCHAR (1000),
	CONSTRAINT XPKSBI_KPI 
              PRIMARY KEY (KPI_ID)
)WITHOUT OIDS;




Create table SBI_KPI_VALUE (
	ID_KPI_INSTANCE_VALUE INTEGER DEFAULT nextval('SBI_KPI_VALUE_SEQ')  NOT NULL ,
	ID_KPI_INSTANCE NUMERIC(38,0)  NOT NULL ,
	VALUE VARCHAR (40),
	BEGIN_DT  TIMESTAMP without time zone,
	END_DT TIMESTAMP without time zone,
	RESOURCE_ID NUMERIC(38,0),
	DESCRIPTION VARCHAR (100),
		CONSTRAINT XPKSBI_KPI_VALUE 
              PRIMARY KEY (ID_KPI_INSTANCE_VALUE)
) WITHOUT OIDS;






Create table SBI_MEASURE_UNIT (
	ID_MEASURE_UNIT INTEGER DEFAULT nextval('SBI_MEASURE_UNIT_SEQ')  NOT NULL ,
	NAME VARCHAR (20),
	SCALE_TYPE_ID INTEGER  NOT NULL ,
	SCALE_CD VARCHAR (40),
	SCALE_NM VARCHAR (400),
		CONSTRAINT XPKSBI_MEASURE_UNIT
              PRIMARY KEY (ID_MEASURE_UNIT)
) WITHOUT OIDS;



Create table SBI_THRESHOLD (
	THRESHOLD_ID INTEGER DEFAULT nextval('SBI_THRESHOLD_SEQ')  NOT NULL ,
	THRESHOLD_TYPE_ID INTEGER  NOT NULL ,
	NAME VARCHAR (127),
	DESCRIPTION VARCHAR (255),
	CODE VARCHAR(45),
	CONSTRAINT XPKSBI_THRESHOLD
              PRIMARY KEY (THRESHOLD_ID)
) WITHOUT OIDS;



Create table SBI_THRESHOLD_VALUE (
	ID_THRESHOLD_VALUE INTEGER DEFAULT nextval('SBI_THRESHOLD_VAULE_SEQ')   NOT NULL ,
	THRESHOLD_ID INTEGER  NOT NULL ,
	SEVERITY_ID INTEGER,
	MIN_VALUE NUMERIC,
	MAX_VALUE NUMERIC,
	LABEL VARCHAR (20),
	COLOUR VARCHAR (20),
	POSITION NUMERIC(38,0),
	CONSTRAINT XPKSBI_THRESHOLD_VALUE
              PRIMARY KEY (ID_THRESHOLD_VALUE)
) WITHOUT OIDS;



Create table SBI_KPI_MODEL (
	KPI_MODEL_ID INTEGER DEFAULT nextval('SBI_KPI_MODEL_SEQ')  NOT NULL ,
	KPI_ID INTEGER,
	KPI_MODEL_TYPE_ID INTEGER  NOT NULL ,
	KPI_PARENT_MODEL_ID INTEGER,
	KPI_MODEL_CD VARCHAR (40),
	KPI_MODEL_NM VARCHAR (400),
	KPI_MODEL_DESC VARCHAR (1000),
	CONSTRAINT XPKSBI_KPI_MODEL
              PRIMARY KEY (KPI_MODEL_ID)
) WITHOUT OIDS;





Create table SBI_KPI_MODEL_ATTR (
	KPI_MODEL_ATTR_ID NUMERIC(38,0)  NOT NULL ,
	KPI_MODEL_ATTR_TYPE_ID INTEGER  NOT NULL ,
	KPI_MODEL_ATTR_CD VARCHAR (40),
	KPI_MODEL_ATTR_NM VARCHAR (400),
	KPI_MODEL_ATTR_DESCR VARCHAR (1000),
		CONSTRAINT XPKSBI_KPI_MODEL_ATTR
              PRIMARY KEY (KPI_MODEL_ATTR_ID)
) WITHOUT OIDS;



Create table SBI_KPI_MODEL_ATTR_VAL (
	KPI_MODEL_ATTR_VAL_ID INTEGER DEFAULT nextval('SBI_KPI_MODEL_ATTR_VAL_SEQ')  NOT NULL ,
	KPI_MODEL_ATTR_ID NUMERIC(38,0)  NOT NULL ,
	KPI_MODEL_ID INTEGER  NOT NULL ,
	VALUE VARCHAR (2048),
		CONSTRAINT XPKSBI_KPI_MODEL_ATTR_VAL
              PRIMARY KEY (KPI_MODEL_ATTR_VAL_ID)
) WITHOUT OIDS;



Create table SBI_KPI_PERIODICITY (
	ID_KPI_PERIODICITY INTEGER DEFAULT nextval('SBI_KPI_PERIODICITY_SEQ')  NOT NULL ,
	NAME VARCHAR (400),
	MONTHS NUMERIC(38,0),
	DAYS NUMERIC(38,0),
	HOURS NUMERIC(38,0),
	MINUTES NUMERIC(38,0),
	chron_string VARCHAR(20),
	start_date TIMESTAMP without time zone,
	CONSTRAINT XPKSBI_KPI_PERIODICITY
              PRIMARY KEY (ID_KPI_PERIODICITY)
) WITHOUT OIDS;



Create table SBI_KPI_INSTANCE (
	ID_KPI_INSTANCE INTEGER DEFAULT nextval('SBI_KPI_INSTANCE_SEQ')  NOT NULL ,
	KPI_ID INTEGER  NOT NULL ,
	THRESHOLD_ID INTEGER,
	ID_MEASURE_UNIT INTEGER,
	WEIGHT NUMERIC(38,0),
	BEGIN_DT TIMESTAMP without time zone,
	CHART_TYPE_ID INTEGER,
	TARGET NUMERIC(38,4),
	CONSTRAINT XPKSBI_KPI_INSTANCE
              PRIMARY KEY (ID_KPI_INSTANCE)
) WITHOUT OIDS;



Create table SBI_KPI_INSTANCE_HISTORY (
	ID_KPI_INSTANCE_HISTORY INTEGER DEFAULT nextval('SBI_KPI_INSTANCE_HISTORY_SEQ')   NOT NULL ,
	ID_MEASURE_UNIT INTEGER   ,
	THRESHOLD_ID INTEGER   ,
	ID_KPI_INSTANCE INTEGER  NOT NULL ,
	WEIGHT NUMERIC(38,0),
	BEGIN_DT TIMESTAMP without time zone,
	END_DT TIMESTAMP without time zone,
	CHART_TYPE_ID INTEGER,
	TARGET NUMERIC(38,6),
	CONSTRAINT XPKSBI_KPI_INSTANCE_HISTORY
              PRIMARY KEY (ID_KPI_INSTANCE_HISTORY)
) WITHOUT OIDS;


Create table SBI_KPI_INST_PERIOD (
  KPI_INST_PERIOD_ID  INTEGER DEFAULT nextval('SBI_KPI_INST_PERIOD_SEQ') NOT NULL,
  KPI_INSTANCE_ID INTEGER NOT NULL,
  PERIODICITY_ID INTEGER NOT NULL,
  DEFAULT_VALUE SMALLINT DEFAULT NULL,
  	CONSTRAINT XPKSBI_KPI_INST_PERIOD
              PRIMARY KEY (KPI_INST_PERIOD_ID)
)WITHOUT OIDS;


Create table SBI_KPI_MODEL_INST (
	KPI_MODEL_INST INTEGER DEFAULT nextval('SBI_KPI_MODEL_INST_SEQ')  NOT NULL ,
	KPI_MODEL_INST_PARENT INTEGER,
	ID_KPI_INSTANCE INTEGER,
	NAME VARCHAR (400),
	LABEL VARCHAR (100) NOT NULL,
	DESCRIPTION VARCHAR (1000),
	START_DATE TIMESTAMP without time zone,
	END_DATE TIMESTAMP without time zone,
	KPI_MODEL_ID NUMERIC(38,0),
	CONSTRAINT XPKSBI_KPI_MODEL_INST
              PRIMARY KEY (KPI_MODEL_INST)
)WITHOUT OIDS;


Create table SBI_RESOURCES (
	RESOURCE_ID NUMERIC(38,0) DEFAULT nextval('RESOURCES_SEQ')  NOT NULL ,
	RESOURCE_TYPE_ID INTEGER  NOT NULL ,
	TABLE_NAME VARCHAR (40),
	COLUMN_NAME VARCHAR (40),
	RESOURCE_NAME VARCHAR (40),
	RESOURCE_DESCR VARCHAR (400),
	CONSTRAINT XPKSBI_RESOURCES
              PRIMARY KEY (RESOURCE_ID)
) WITHOUT OIDS;


Create table SBI_KPI_MODEL_RESOURCES (
	KPI_MODEL_RESOURCES_ID  INTEGER DEFAULT nextval('SBI_KPI_MODEL_RESOURCES_SEQ')  NOT NULL,
	RESOURCE_ID INTEGER NOT NULL,
	KPI_MODEL_INST INTEGER NOT NULL,
 	CONSTRAINT XPKSBI_KPI_MODEL_RESOURCES
              PRIMARY KEY (KPI_MODEL_RESOURCES_ID)
) WITHOUT OIDS;


Create table SBI_ALARM (
	ALARM_ID NUMERIC(38,0)  NOT NULL ,
	ID_KPI_INSTANCE INTEGER  NOT NULL ,
	MODALITY_ID INTEGER  NOT NULL ,
	DOCUMENT_ID INTEGER,
	LABEL VARCHAR (50),
	NAME VARCHAR (50),
	DESCR VARCHAR (200),
	TEXT VARCHAR (1000),
	URL VARCHAR (20),
	SINGLE_EVENT Char (1),
	AUTO_DISABLED Char (1),
	ID_THRESHOLD_VALUE INTEGER,
	CONSTRAINT XPKSBI_ALARM
              PRIMARY KEY (ALARM_ID)
)WITHOUT OIDS;


Create table SBI_ALARM_EVENT (
	ALARM_EVENT_ID NUMERIC(38,0)  NOT NULL ,
	ALARM_ID INTEGER  NOT NULL ,
	EVENT_TS TIMESTAMP without time zone,
	ACTIVE Char (1),
	KPI_VALUE VARCHAR (50),
	THRESHOLD_VALUE VARCHAR (50),
	KPI_NAME VARCHAR (100),
	RESOURCES VARCHAR (200),
	KPI_DESCRIPTION VARCHAR (100),
	RESOURCE_ID INTEGER,
  KPI_INSTANCE_ID INTEGER,
	CONSTRAINT XPKSBI_ALARM_EVENT
              PRIMARY KEY (ALARM_EVENT_ID)
) WITHOUT OIDS;


Create table SBI_ALARM_DISTRIBUTION (
	ALARM_CONTACT_ID INTEGER NOT NULL,
	ALARM_ID INTEGER NOT NULL,
 	CONSTRAINT XPKSBI_ALARM_DISTRIBUTION
              PRIMARY KEY (ALARM_CONTACT_ID, ALARM_ID)
) WITHOUT OIDS;


Create table SBI_ALARM_CONTACT (
	ALARM_CONTACT_ID INTEGER NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	EMAIL VARCHAR(100),
	MOBILE VARCHAR(50),
	RESOURCES VARCHAR(200),
 	CONSTRAINT XPKSBI_ALARM_CONTACT
              PRIMARY KEY (ALARM_CONTACT_ID)
) WITHOUT OIDS;



-- KPI DEFINITION
Alter table SBI_KPI_MODEL_ATTR add FOREIGN KEY(KPI_MODEL_ATTR_TYPE_ID) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_KPI_MODEL_ATTR_VAL add Foreign Key (KPI_MODEL_ID) references SBI_KPI_MODEL (KPI_MODEL_ID);
Alter table SBI_KPI_MODEL_ATTR_VAL add Foreign Key (KPI_MODEL_ID) references SBI_KPI_MODEL (KPI_MODEL_ID);
Alter table SBI_KPI_MODEL_ATTR_VAL add  Foreign Key (KPI_MODEL_ATTR_ID) references SBI_KPI_MODEL_ATTR (KPI_MODEL_ATTR_ID);
Alter table SBI_KPI_MODEL add  Foreign Key (KPI_ID) references SBI_KPI (KPI_ID);
Alter table SBI_KPI_MODEL add  Foreign Key (KPI_MODEL_TYPE_ID) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_KPI_MODEL add  Foreign Key (KPI_PARENT_MODEL_ID) references SBI_KPI_MODEL (KPI_MODEL_ID);
Alter table SBI_MEASURE_UNIT add  Foreign Key (SCALE_TYPE_ID) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_KPI add  Foreign Key (DS_ID) references SBI_DATA_SET (DS_ID);
Alter table SBI_KPI add  Foreign Key (DS_ID) references SBI_DATA_SET (DS_ID);
Alter table SBI_KPI add  Foreign Key (id_kpi_parent) references SBI_KPI (KPI_ID);
Alter table SBI_KPI add Foreign Key (id_measure_unit) references SBI_MEASURE_UNIT (id_measure_unit);
Alter table SBI_KPI add Foreign Key (THRESHOLD_ID) references SBI_THRESHOLD (THRESHOLD_ID) ;
Alter table SBI_KPI_ROLE add  Foreign Key (EXT_ROLE_ID) references SBI_EXT_ROLES (EXT_ROLE_ID) ;
Alter table SBI_KPI_ROLE add  Foreign Key (KPI_ID) references SBI_KPI (KPI_ID);
Alter table SBI_THRESHOLD add Foreign Key (THRESHOLD_TYPE_ID) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_THRESHOLD_VALUE add  Foreign Key (SEVERITY_ID) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_THRESHOLD_VALUE add Foreign Key (THRESHOLD_ID) references SBI_THRESHOLD (THRESHOLD_ID) on delete cascade;

Alter table SBI_KPI_MODEL_INST add  Foreign Key (id_kpi_instance) references SBI_KPI_INSTANCE (id_kpi_instance);
Alter table SBI_KPI_MODEL_INST add  Foreign Key (KPI_MODEL_INST_PARENT) references SBI_KPI_MODEL_INST (KPI_MODEL_INST);
Alter table SBI_KPI_INSTANCE add  Foreign Key (KPI_ID) references SBI_KPI (KPI_ID);
Alter table SBI_KPI_INSTANCE add Foreign Key (id_measure_unit) references SBI_MEASURE_UNIT (id_measure_unit);
Alter table SBI_KPI_INSTANCE add  Foreign Key (THRESHOLD_ID) references SBI_THRESHOLD (THRESHOLD_ID);
Alter table SBI_KPI_INSTANCE add  Foreign Key (CHART_TYPE_ID) references SBI_DOMAINS (value_id);
Alter table SBI_KPI_INSTANCE_HISTORY add  Foreign Key (id_measure_unit) references SBI_MEASURE_UNIT (id_measure_unit) ;
Alter table SBI_KPI_INSTANCE_HISTORY add  Foreign Key (THRESHOLD_ID) references SBI_THRESHOLD (THRESHOLD_ID);
Alter table SBI_KPI_INSTANCE_HISTORY add  Foreign Key (id_kpi_instance) references SBI_KPI_INSTANCE (id_kpi_instance) ;
Alter table SBI_KPI_MODEL_RESOURCES add  Foreign Key (KPI_MODEL_INST) references SBI_KPI_MODEL_INST (KPI_MODEL_INST);
Alter table SBI_KPI_MODEL_RESOURCES add  Foreign Key (RESOURCE_ID) references SBI_RESOURCES (RESOURCE_ID);
Alter table SBI_RESOURCES add  Foreign Key (RESOURCE_TYPE_ID) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_KPI_VALUE add  Foreign Key (id_kpi_instance) references SBI_KPI_INSTANCE (id_kpi_instance);
Alter table SBI_KPI_VALUE add  Foreign Key (RESOURCE_ID) references SBI_RESOURCES (RESOURCE_ID);
Alter TABLE SBI_KPI_INST_PERIOD ADD FOREIGN KEY  (KPI_INSTANCE_ID) REFERENCES SBI_KPI_INSTANCE (id_kpi_instance);
Alter TABLE SBI_KPI_INST_PERIOD ADD  FOREIGN KEY (PERIODICITY_ID) REFERENCES SBI_KPI_PERIODICITY (ID_KPI_PERIODICITY) ;

Alter table SBI_ALARM add  Foreign Key (MODALITY_ID) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_ALARM add Foreign Key (DOCUMENT_ID) references SBI_OBJECTS (BIOBJ_ID);
Alter table SBI_ALARM add  Foreign Key (id_kpi_instance) references SBI_KPI_INSTANCE (id_kpi_instance) ;
Alter table SBI_ALARM add Foreign Key (id_threshold_value) references SBI_THRESHOLD_VALUE (ID_THRESHOLD_VALUE);
Alter table SBI_ALARM_EVENT add  Foreign Key (ALARM_ID) references SBI_ALARM (ALARM_ID);
Alter table SBI_ALARM_DISTRIBUTION add  Foreign Key (ALARM_ID) references SBI_ALARM (ALARM_ID);
Alter table SBI_ALARM_DISTRIBUTION add  Foreign Key (ALARM_CONTACT_ID) references SBI_ALARM_CONTACT (ALARM_CONTACT_ID);
Alter table SBI_KPI add  Foreign Key (KPI_TYPE) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_KPI add  Foreign Key (METRIC_SCALE_TYPE) references SBI_DOMAINS (VALUE_ID);
Alter table SBI_KPI add  Foreign Key (MEASURE_TYPE) references SBI_DOMAINS (VALUE_ID);


-- ##################################################################################################
-- 	From 2.1 
-- ##################################################################################################

ALTER TABLE sbi_data_set ADD COLUMN language_script character(50)[];

ALTER TABLE sbi_domains ALTER value_cd TYPE character varying(101);
ALTER TABLE sbi_functions ALTER code TYPE character varying(40);

ALTER TABLE sbi_data_source ALTER url_connection TYPE character varying(500);
ALTER TABLE sbi_data_source ALTER COLUMN url_connection SET DEFAULT NULL;

-- ##################################################################################################
-- 	From 2.2 
-- ##################################################################################################
- angelo
-31/07/09
ALTER TABLE sbi_data_source ADD COLUMN MULTI_SCHEMA TINYINT(1) NOT NULL DEFAULT '0';
ALTER TABLE sbi_data_source ADD COLUMN ATTR_SCHEMA VARCHAR(45) DEFAULT NULL;

- davide
-07/09/09
ALTER TABLE SBI_EXT_ROLES ADD COLUMN BUILD_QBE_QUERY BOOLEAN DEFAULT TRUE;

-chiara
-09/09/2009
ALTER TABLE SBI_KPI_VALUE ADD COLUMN XML_DATA TEXT;

-- ##################################################################################################
-- 	From 2.3
-- ##################################################################################################

-giulio
-05/11/2009
ALTER TABLE SBI_DATA_SET ADD COLUMN DS_METADATA VARCHAR(2000) DEFAULT NULL;

-antonella
-12/11/2009
ALTER TABLE SBI_OBJECT_NOTES ADD COLUMN OWNER VARCHAR(50);
ALTER TABLE SBI_OBJECT_NOTES ADD COLUMN ISPUBLIC BOOLEAN;
ALTER TABLE SBI_OBJECT_NOTES ADD COLUMN CREATION_DATE DATE NOT NULL DEFAULT CURRENT_TIMESTAMP;
ALTER TABLE SBI_OBJECT_NOTES ADD COLUMN LAST_CHANGE_DATE DATE NOT NULL DEFAULT CURRENT_TIMESTAMP;
/* force a valid value for date and owner fields in existing records: */
UPDATE SBI_OBJECT_NOTES SET LAST_CHANGE_DATE = CURRENT_TIMESTAMP,CREATION_DATE = CURRENT_TIMESTAMP;
UPDATE SBI_OBJECT_NOTES SET OWNER = 'biadmin';
COMMIT;
-19/11/2009
DELETE FROM SBI_REMEMBER_ME WHERE SUBOBJ_ID IN (SELECT SUBOBJ_ID FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_AUDIT WHERE SUBOBJ_ID IN (SELECT SUBOBJ_ID FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_MENU WHERE SUBOBJ_NAME IN (SELECT NAME FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_BINARY_CONTENTS WHERE BIN_ID IN (SELECT BIN_ID FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME ='');
DELETE FROM SBI_SUBOBJECTS WHERE NAME IS NULL OR NAME =''; 
COMMIT;
ALTER TABLE SBI_SUBOBJECTS ALTER COLUMN NAME TYPE VARCHAR(50);
-24/11/2009
ALTER TABLE SBI_OBJECTS DROP COLUMN DESCR_EXT;
ALTER TABLE SBI_OBJECTS DROP COLUMN OBJECTIVE;
ALTER TABLE SBI_OBJECTS DROP COLUMN LANGUAGE;
ALTER TABLE SBI_OBJECTS DROP COLUMN KEYWORDS;

ALTER TABLE SBI_EXT_ROLES ADD COLUMN SAVE_METADATA BOOLEAN DEFAULT TRUE;

CREATE SEQUENCE SBI_OBJ_METADATA_SEQ INCREMENT 1 START  1 ;
CREATE TABLE SBI_OBJ_METADATA (
	OBJ_META_ID 		INTEGER DEFAULT nextval('SBI_OBJ_METADATA_SEQ') NOT NULL,
    LABEL	 	        VARCHAR(20) NOT NULL,
    NAME 	            VARCHAR(40) NOT NULL,
    DESCRIPTION	        VARCHAR(100),  
    DATA_TYPE_ID		INTEGER NOT NULL,
    CREATION_DATE 	    DATE NOT NULL DEFAULT CURRENT_TIMESTAMP,  
    PRIMARY KEY (OBJ_META_ID)
)WITHOUT OIDS;

CREATE UNIQUE INDEX XAK1SBI_OBJ_METADATA ON SBI_OBJ_METADATA
(
       OBJ_META_ID
);

ALTER TABLE SBI_OBJ_METADATA ADD  FOREIGN KEY (DATA_TYPE_ID) REFERENCES SBI_DOMAINS (VALUE_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;

CREATE SEQUENCE SBI_OBJ_METACONTENTS_SEQ INCREMENT 1 START  1 ;
CREATE TABLE SBI_OBJ_METACONTENTS (
  OBJ_METACONTENT_ID INTEGER DEFAULT nextval('SBI_OBJ_METACONTENTS_SEQ') NOT NULL,
  OBJMETA_ID 		 INTEGER  NOT NULL ,
  BIOBJ_ID 			 INTEGER  NOT NULL,
  SUBOBJ_ID 		 INTEGER,
  BIN_ID 			 INTEGER,
  CREATION_DATE 	 DATE NOT NULL DEFAULT CURRENT_TIMESTAMP,  
  LAST_CHANGE_DATE   DATE NOT NULL DEFAULT CURRENT_TIMESTAMP,  
    PRIMARY KEY (OBJ_METACONTENT_ID)
)WITHOUT OIDS;

CREATE UNIQUE INDEX XAK1SBI_OBJ_METACONTENTS ON SBI_OBJ_METACONTENTS
(
        OBJMETA_ID,
        BIOBJ_ID,
        SUBOBJ_ID
);

ALTER TABLE SBI_OBJ_METACONTENTS ADD  FOREIGN KEY ( OBJMETA_ID ) REFERENCES SBI_OBJ_METADATA (  OBJ_META_ID ) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE SBI_OBJ_METACONTENTS ADD  FOREIGN KEY ( BIOBJ_ID )   REFERENCES SBI_OBJECTS (  BIOBJ_ID ) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE SBI_OBJ_METACONTENTS ADD  FOREIGN KEY ( SUBOBJ_ID )  REFERENCES SBI_SUBOBJECTS (  SUBOBJ_ID ) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE SBI_OBJ_METACONTENTS ADD  FOREIGN KEY ( BIN_ID )     REFERENCES SBI_BINARY_CONTENTS(BIN_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;

--adds new funcionality for metadata management
INSERT INTO SBI_USER_FUNC (NAME, DESCRIPTION) VALUES ('ObjMetadataManagement', 'ObjMetadataManagement');
INSERT INTO  SBI_ROLE_TYPE_USER_FUNC values((SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'ROLE_TYPE' AND VALUE_CD = 'ADMIN'), (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC WHERE NAME='ObjMetadataManagement'));
COMMIT;

-chiara
ALTER TABLE SBI_SUBOBJECTS MODIFY COLUMN DESCRIPTION VARCHAR(1000) DEFAULT NULL;

-- Giulio 4/1/2010
ALTER TABLE sbi_lov MODIFY COLUMN LOV_PROVIDER TEXT DEFAULT NULL;

-- Monica 11/01/2010
CREATE TABLE SBI_USER (
	USER_ID VARCHAR(100) NOT NULL,
	PASSWORD VARCHAR(150),
	FULL_NAME VARCHAR(255),
	DT_PWD_BEGIN TIMESTAMP,
	DT_PWD_END TIMESTAMP, 
	FLG_PWD_BLOCKED SMALLINT,
	DT_LAST_ACCESS TIMESTAMP,
	ID INTEGER NOT NULL,
 PRIMARY KEY (ID));

CREATE TABLE SBI_ATTRIBUTE (
	ATTRIBUTE_NAME VARCHAR(255) NOT NULL,
	DESCRIPTION VARCHAR(500) NOT NULL,
	ATTRIBUTE_ID INTEGER NOT NULL,
 PRIMARY KEY (ATTRIBUTE_ID));

CREATE TABLE SBI_USER_ATTRIBUTES (
	ID INTEGER NOT NULL,
	ATTRIBUTE_ID INTEGER NOT NULL,
	ATTRIBUTE_VALUE VARCHAR(500),
 PRIMARY KEY (ID,ATTRIBUTE_ID));


CREATE TABLE SBI_EXT_USER_ROLES (
	ID INTEGER NOT NULL,
	EXT_ROLE_ID INTEGER NOT NULL,
 PRIMARY KEY (ID,EXT_ROLE_ID));


ALTER TABLE SBI_USER_ATTRIBUTES ADD FOREIGN KEY (ID) REFERENCES SBI_USER (ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE SBI_EXT_USER_ROLES ADD FOREIGN KEY (ID) REFERENCES SBI_USER (ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE SBI_USER_ATTRIBUTES ADD FOREIGN KEY (ATTRIBUTE_ID) REFERENCES SBI_ATTRIBUTE (ATTRIBUTE_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE SBI_EXT_USER_ROLES ADD FOREIGN KEY (EXT_ROLE_ID) REFERENCES SBI_EXT_ROLES (EXT_ROLE_ID) ON UPDATE RESTRICT ON DELETE RESTRICT;

--Antonella 19/01/2010
/** configuration table*/
CREATE SEQUENCE SBI_CONFIG_SEQ INCREMENT 1 START  1 ;
CREATE TABLE SBI_CONFIG (
	ID 				INTEGER DEFAULT nextval('SBI_CONFIG_SEQ') NOT NULL,
	LABEL			VARCHAR(100) NOT NULL,
	NAME			VARCHAR(100) NULL,
	DESCRIPTION 	VARCHAR(500) NULL,
	IS_ACTIVE 		BOOLEAN DEFAULT TRUE,
	VALUE_CHECK 	VARCHAR(1000) NULL,
	VALUE_TYPE_ID 	INTEGER NULL,    
 PRIMARY KEY (ID));
 
 
CREATE UNIQUE INDEX XAK1SBI_CONFIG ON SBI_CONFIG
(
       LABEL                      
);



ALTER TABLE SBI_CONFIG ADD CONSTRAINT FK_sbi_config_1 FOREIGN KEY ( VALUE_TYPE_ID ) REFERENCES SBI_DOMAINS ( VALUE_ID );

/** inserts data into new table for initial management of change pwd */
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwdmodule.len_min', 'LEN_MIN', 'Minimum length', false, 8, 20 );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwdmodule.special_char', 'Special char', 'Special chars', false, '_|-<>#$', 21 );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwdmodule.upper_char', 'Upper char', 'Minimum a char must be in upper case', false,'ABCDEFGJKLMNOPQRSTUVWXYZ', 21 );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwdmodule.lower_char', 'Lower char', 'Minimum a char must be in lower case', true,'abcdefghjklmnopqrstuwxyz', 21 );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwdmodule.number', 'Number', 'Minimum a char must be a number', false,'0123456789', 21 );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwdmodule.alphabetical', 'Alaphabetical', 'Minimum a char must be a letter', true,'abcdefghjklmnopqrstuwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', 21 );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwdmodule.change', 'Change from last', 'The new pwd must be different from the lastest', true,null, null );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwd.change_first', 'Change at first login ', 'The pwd must be changed at first login', false,null, null );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwd.disactivation_time', 'Disactivation time', 'Number of months before disactivation', true,'6', 20 );
INSERT INTO SBI_CONFIG (LABEL, NAME, DESCRIPTION, IS_ACTIVE, VALUE_CHECK, VALUE_TYPE_ID) VALUES ('changepwd.expired_time', 'Expired time', 'Number of days fo the expiration', true,'90', 20 );
COMMIT;

--Antonella 27/01/2010
/** change creation date datatype (date --> timestamp) */
ALTER TABLE SBI_VIEWPOINTS ALTER COLUMN  VP_CREATION_DATE TYPE TIMESTAMP;


--Chiara 03/02/2010
CREATE SEQUENCE SBI_ACTIVITY_SEQ INCREMENT 1 START 1 ;
CREATE TABLE SBI_ACTIVITY_MONITORING (
  ID INTEGER DEFAULT nextval('SBI_ACTIVITY_SEQ') NOT NULL,
  ACTION_TIME DATE DEFAULT CURRENT_TIMESTAMP,
  USERNAME 	 	VARCHAR(40) NOT NULL,
  USERGROUP		VARCHAR(400),
  LOG_LEVEL 	VARCHAR(10) ,
  ACTION_CODE 	VARCHAR(45) NOT NULL,
  INFO 			VARCHAR(400),
  PRIMARY KEY (ID)
) WITHOUT OIDS;

CREATE UNIQUE INDEX XAK1SBI_USER ON SBI_USER
(
       USER_ID                          ASC
);

ALTER TABLE SBI_ALARM MODIFY COLUMN ID_KPI_INSTANCE INTEGER,
 MODIFY COLUMN ID_THRESHOLD_VALUE INTEGER;
 
 
-- ##################################################################################################
-- 	From 2.5
-- ##################################################################################################

 --Chiara 27/05/2010
ALTER TABLE SBI_RESOURCES ADD COLUMN RESOURCE_CODE VARCHAR(45);
UPDATE SBI_RESOURCES SET RESOURCE_CODE = RESOURCE_NAME;
CREATE UNIQUE INDEX UNIQUE_RES_CODE ON SBI_RESOURCES(RESOURCE_CODE);
ALTER TABLE SBI_RESOURCES ALTER COLUMN RESOURCE_CODE SET NOT NULL;>>>>>>> .r11549

 -- Giulio 27 /05 / 2010
 CREATE SEQUENCE SBI_KPI_MODEL_ATTR_SEQ INCREMENT 1 START  1 ;
 MODIFY COLUMN ID_THRESHOLD_VALUE INTEGER;
 
 --Chiara 28/08/2010
CREATE SEQUENCE SBI_KPI_DOCUMENTS_SEQ INCREMENT 1 START  1 ;

Create table SBI_KPI_DOCUMENTS (
	ID_KPI_DOC INTEGER  DEFAULT nextval('SBI_KPI_DOCUMENTS_SEQ') NOT NULL,
	BIOBJ_ID INTEGER NOT NULL,
	KPI_ID INTEGER NOT NULL,
 Primary Key (ID_KPI_DOC)
)WITHOUT OIDS;

Alter table SBI_KPI_DOCUMENTS add Foreign Key (BIOBJ_ID) references SBI_OBJECTS (BIOBJ_ID) ;
Alter table SBI_KPI_DOCUMENTS add Foreign Key (KPI_ID) references SBI_KPI (KPI_ID);

INSERT INTO SBI_KPI_DOCUMENTS(KPI_ID,BIOBJ_ID)
SELECT k.KPI_ID, o.BIOBJ_ID
FROM sbi_kpi k,sbi_Objects o
WHERE
k.DOCUMENT_LABEL = o.LABEL
and k.DOCUMENT_LABEL IS NOT NULL;

ALTER TABLE SBI_KPI DROP COLUMN document_label;

--Antonella 08/09/2010: generic user data properties management
CREATE SEQUENCE SBI_UDP_SEQ INCREMENT 1 START  1 ;
CREATE TABLE SBI_UDP (
	UDP_ID	        INTEGER DEFAULT nextval('SBI_UDP_SEQ') NOT NULL,
	TYPE_ID			INTEGER NOT NULL,
	FAMILY_ID		INTEGER NOT NULL,
	LABEL           VARCHAR(20) NOT NULL,
	NAME            VARCHAR(40) NOT NULL,
	DESCRIPTION     VARCHAR(1000) NULL,
	IS_MULTIVALUE   BOOLEAN DEFAULT FALSE,    
 PRIMARY KEY (UDP_ID));
 
CREATE UNIQUE INDEX XAK1SBI_UDP ON SBI_UDP(LABEL);
CREATE INDEX XIF3_SBI_SBI_UDP ON SBI_UDP(TYPE_ID);
CREATE INDEX XIF2SBI_SBI_UDP ON SBI_UDP(FAMILY_ID);

ALTER TABLE SBI_UDP ADD FOREIGN KEY ( TYPE_ID ) REFERENCES SBI_DOMAINS ( VALUE_ID );
ALTER TABLE SBI_UDP ADD FOREIGN KEY ( FAMILY_ID ) REFERENCES SBI_DOMAINS ( VALUE_ID ) ;

CREATE SEQUENCE SBI_UDP_VALUE_SEQ INCREMENT 1 START  1 ;
CREATE TABLE SBI_UDP_VALUE (
	UDP_VALUE_ID       INTEGER DEFAULT nextval('SBI_UDP_SEQ') NOT NULL,
	UDP_ID			   INTEGER NOT NULL,
	VALUE              VARCHAR(1000) NOT NULL,
	PROG               INTEGER NULL,
	LABEL              VARCHAR(20) NOT NULL,
	NAME               VARCHAR(40) NULL,
	FAMILY			   VARCHAR(40) NULL,
    BEGIN_TS           TIMESTAMP NOT NULL,
    END_TS             TIMESTAMP NULL,
    REFERENCE_ID	   INTEGER NULL,	
 PRIMARY KEY (UDP_VALUE_ID));
 
CREATE INDEX XIF2SBI_SBI_UDP_VALUE ON SBI_UDP_VALUE(UDP_ID);

ALTER TABLE SBI_UDP_VALUE ADD FOREIGN KEY ( UDP_ID ) REFERENCES SBI_UDP ( UDP_ID );

--adds new funcionality for udp management
INSERT INTO SBI_USER_FUNC (NAME, DESCRIPTION) VALUES ('UserDefinedPropertyManagement', 'UserDefinedPropertyManagement');
INSERT INTO  SBI_ROLE_TYPE_USER_FUNC values((SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'ROLE_TYPE' AND VALUE_CD = 'ADMIN'), (SELECT USER_FUNCT_ID FROM SBI_USER_FUNC WHERE NAME='UserDefinedPropertyManagement'));
COMMIT;
--KPI RELATIONS Monica
CREATE SEQUENCE SBI_KPI_REL_SEQ INCREMENT 1 START  1 ;

CREATE TABLE SBI_KPI_REL (
  KPI_REL_ID INTEGER NOT NULL,
  KPI_FATHER_ID INTEGER  NOT NULL,
  KPI_CHILD_ID INTEGER  NOT NULL,
  PARAMETER VARCHAR(100) NULL,
  PRIMARY KEY (KPI_REL_ID)
);

ALTER TABLE SBI_KPI_REL ADD FOREIGN KEY ( KPI_FATHER_ID ) REFERENCES SBI_KPI ( KPI_ID );
ALTER TABLE SBI_KPI_REL ADD FOREIGN KEY ( KPI_CHILD_ID ) REFERENCES SBI_KPI ( KPI_ID );
 
-- 28/09/2010
CREATE SEQUENCE SBI_KPI_ERROR_SEQ INCREMENT 1 START  1 ;

 -- ggavardi 28/09/2010
 CREATE SEQUENCE SBI_KPI_ERROR_SEQ INCREMENT 1 START  1 ;

CREATE TABLE SBI_KPI_ERROR (
  KPI_ERROR_ID        INTEGER     DEFAULT nextval('SBI_KPI_ERROR') NOT NULL,
  KPI_MODEL_INST_ID   INTEGER NOT NULL,
  USER_MSG            VARCHAR(1000),
  FULL_MSG             TEXT,
  TS_DATE             TIMESTAMP ,
  LABEL_MOD_INST      VARCHAR(100) ,
  PARAMETERS	       VARCHAR(1000),
  PRIMARY KEY (KPI_ERROR_ID)) WITHOUT OIDS;
  
ALTER TABLE SBI_KPI_ERROR ADD FOREIGN KEY KPI_MODEL_INST_ID REFERENCES SBI_KPI_MODEL_INST ( KPI_MODEL_INST );

--Chiara 28/09/2010
DROP TABLE SBI_KPI_MODEL_ATTR_VAL;
DROP TABLE SBI_KPI_MODEL_ATTR;

--new column on SBI_KPI
ALTER TABLE SBI_KPI ADD COLUMN IS_ADDITIVE CHAR(1);

--Davide 29/09/2010 (Organizationl Unit)
CREATE TABLE SBI_ORG_UNIT (
  ID            INTEGER NOT NULL,
  LABEL            VARCHAR(200) NOT NULL,
  NAME             VARCHAR(400) NOT NULL,
  DESCRIPTION      VARCHAR(1000),
  CONSTRAINT XAK1SBI_ORG_UNIT UNIQUE (LABEL),
  CONSTRAINT XPKSBI_ORG_UNIT PRIMARY KEY(ID)
) WITHOUT OIDS;

CREATE TABLE SBI_ORG_UNIT_HIERARCHIES (
  ID            INTEGER NOT NULL,
  LABEL            VARCHAR(100) NOT NULL,
  NAME             VARCHAR(200) NOT NULL,
  DESCRIPTION      VARCHAR(1000),
  TARGET     VARCHAR(1000),
  COMPANY    VARCHAR(100) NOT NULL,
  CONSTRAINT XAK1SBI_ORG_UNIT_HIERARCHIES UNIQUE (LABEL, COMPANY),
  CONSTRAINT XPKSBI_ORG_UNIT_HIERARCHIES PRIMARY KEY(ID)
) WITHOUT OIDS;

CREATE TABLE SBI_ORG_UNIT_NODES (
  NODE_ID            INTEGER NOT NULL,
  OU_ID           INTEGER NOT NULL,
  HIERARCHY_ID  INTEGER NOT NULL,
  PARENT_NODE_ID INTEGER NULL,
  PATH VARCHAR(4000) NOT NULL,
  CONSTRAINT XPKSBI_ORG_UNIT_NODES PRIMARY KEY(NODE_ID)
) WITHOUT OIDS;

CREATE TABLE SBI_ORG_UNIT_GRANT (
  ID INTEGER NOT NULL,
  HIERARCHY_ID  INTEGER NOT NULL,
  KPI_MODEL_INST_NODE_ID INTEGER NOT NULL,
  START_DATE  DATE,
  END_DATE  DATE,
  LABEL            VARCHAR(200) NOT NULL,
  NAME             VARCHAR(400) NOT NULL,
  DESCRIPTION      VARCHAR(1000),
  CONSTRAINT XAK1SBI_ORG_UNIT_GRANT UNIQUE (LABEL),
  CONSTRAINT XPKSBI_ORG_UNIT_GRANT PRIMARY KEY(ID)
) WITHOUT OIDS;

CREATE TABLE SBI_ORG_UNIT_GRANT_NODES (
  NODE_ID INTEGER NOT NULL,
  KPI_MODEL_INST_NODE_ID INTEGER NOT NULL,
  GRANT_ID INTEGER NOT NULL,
  CONSTRAINT XPKSBI_ORG_UNIT_GRANT_NODES PRIMARY KEY(NODE_ID, KPI_MODEL_INST_NODE_ID, GRANT_ID)
) WITHOUT OIDS;


ALTER TABLE SBI_ORG_UNIT_NODES ADD FOREIGN KEY ( OU_ID ) REFERENCES SBI_ORG_UNIT ( ID ) ON DELETE CASCADE;
ALTER TABLE SBI_ORG_UNIT_NODES ADD FOREIGN KEY ( HIERARCHY_ID ) REFERENCES SBI_ORG_UNIT_HIERARCHIES ( ID ) ON DELETE CASCADE;
ALTER TABLE SBI_ORG_UNIT_NODES ADD FOREIGN KEY ( PARENT_NODE_ID ) REFERENCES SBI_ORG_UNIT_NODES ( NODE_ID ) ON DELETE CASCADE;
ALTER TABLE SBI_ORG_UNIT_GRANT ADD FOREIGN KEY ( HIERARCHY_ID ) REFERENCES SBI_ORG_UNIT_HIERARCHIES ( ID ) ON DELETE CASCADE;
ALTER TABLE SBI_ORG_UNIT_GRANT ADD FOREIGN KEY ( KPI_MODEL_INST_NODE_ID ) REFERENCES SBI_KPI_MODEL_INST ( KPI_MODEL_INST ) ON DELETE CASCADE;
ALTER TABLE SBI_ORG_UNIT_GRANT_NODES ADD FOREIGN KEY ( NODE_ID ) REFERENCES SBI_ORG_UNIT_NODES ( NODE_ID ) ON DELETE CASCADE;
ALTER TABLE SBI_ORG_UNIT_GRANT_NODES ADD FOREIGN KEY ( KPI_MODEL_INST_NODE_ID ) REFERENCES SBI_KPI_MODEL_INST ( KPI_MODEL_INST ) ON DELETE CASCADE;
ALTER TABLE SBI_ORG_UNIT_GRANT_NODES ADD FOREIGN KEY ( GRANT_ID ) REFERENCES SBI_ORG_UNIT_GRANT ( ID ) ON DELETE CASCADE;
--Monica 18/10/2010: OU kpi
ALTER TABLE SBI_KPI_VALUE add COLUMN ORG_UNIT_ID integer;

--Davide 12/10/2010: analytical drivers are visible by default
UPDATE SBI_OBJ_PAR SET VIEW_FL = 1;

--Davide 05/11/2010: added COMPANY column to SBI_ORG_UNIT_HIERARCHIES
ALTER TABLE SBI_ORG_UNIT_HIERARCHIES ADD COLUMN COMPANY VARCHAR(200);
COMMIT;

--BUG ON DUPLICATE ROLE NAMES
ALTER TABLE SBI_EXT_ROLES ALTER COLUMN NAME SET NOT NULL;
ALTER TABLE SBI_EXT_ROLES ADD CONSTRAINT XPGNAME UNIQUE (NAME);
--kpi_value added columns hierarchy_id and company
ALTER TABLE SBI_KPI_VALUE add COLUMN HIERARCHY_ID integer;
ALTER TABLE SBI_KPI_VALUE add COLUMN COMPANY VARCHAR(200);

--Davide 11/11/2010 (Organizationl Unit: colums LABEL and NAME resized to 100; unique key is (LABEL,NAME))
ALTER TABLE SBI_ORG_UNIT ALTER COLUMN LABEL TYPE VARCHAR(100);
ALTER TABLE SBI_ORG_UNIT ALTER COLUMN NAME TYPE VARCHAR(100);
ALTER TABLE SBI_ORG_UNIT DROP CONSTRAINT XAK1SBI_ORG_UNIT;
ALTER TABLE SBI_ORG_UNIT ADD CONSTRAINT XAK1SBI_ORG_UNIT UNIQUE (LABEL, NAME);

--Davide 16/11/2010: added url to external application in menu configuration
ALTER TABLE SBI_MENU ADD COLUMN EXT_APP_URL VARCHAR(1000);

--Andrea 20/12/2010: added to solve bug SPAGOBI-433
ALTER TABLE SBI_EVENTS_LOG MODIFY COLUMN DESCR TEXT;

--Monica 29/12/2010 : to solve bug SPAGOBI-443
ALTER TABLE SBI_OBJECT_NOTES
	ALTER COLUMN ISPUBLIC TYPE boolean
		USING CASE WHEN ISPUBLIC = 0 THEN FALSE
			WHEN ISPUBLIC = 1 THEN TRUE
			ELSE NULL
			END;
			
--Monica 10/01/2011: error in OU name filed too short			
ALTER TABLE SBI_ORG_UNIT ALTER COLUMN NAME type varchar(200);

--Alberto 11/01/2011: goal scripts
ALTER TABLE SBI_OBJECT_NOTES
	ALTER COLUMN ISPUBLIC TYPE boolean
		USING CASE WHEN ISPUBLIC = 0 THEN FALSE
			WHEN ISPUBLIC = 1 THEN TRUE
			ELSE NULL
			END;
			
CREATE SEQUENCE SBI_GOAL_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_GOAL_HIERARCHY_SEQ INCREMENT 1 START  1 ;
CREATE SEQUENCE SBI_GOAL_KPI_SEQ INCREMENT 1 START  1 ;


CREATE TABLE SBI_GOAL (
  GOAL_ID       INTEGER DEFAULT nextval('SBI_GOAL_SEQ') NOT NULL,
  GRANT_ID      INTEGER NOT NULL,
  START_DATE    DATE NOT NULL,
  END_DATE      DATE NOT NULL,
  NAME          VARCHAR(20) NOT NULL,
  LABEL          VARCHAR(20) NOT NULL,
  DESCRIPTION		VARCHAR(1000),
  CONSTRAINT XPKSBI_GOAL PRIMARY KEY (GOAL_ID)
) WITHOUT OIDS;


CREATE TABLE SBI_GOAL_HIERARCHY (
  GOAL_HIERARCHY_ID INTEGER DEFAULT nextval('SBI_GOAL_HIERARCHY_SEQ') NOT NULL,
  ORG_UNIT_ID       INTEGER NOT NULL,
  GOAL_ID           INTEGER NOT NULL,
  PARENT_ID         INTEGER,
  NAME              VARCHAR(50) NOT NULL,
  LABEL             VARCHAR(50),
  GOAL              VARCHAR(1000),
  CONSTRAINT XPKSBI_GOAL_HIERARCHY PRIMARY KEY (GOAL_HIERARCHY_ID)
) WITHOUT OIDS;


CREATE TABLE SBI_GOAL_KPI (
  GOAL_KPI_ID         INTEGER DEFAULT nextval('SBI_GOAL_KPI_SEQ') NOT NULL,
  KPI_INSTANCE_ID     INTEGER NOT NULL,
  GOAL_HIERARCHY_ID   INTEGER NOT NULL,
  WEIGHT1             FLOAT(8),
  WEIGHT2             FLOAT(8),
  THRESHOLD1          FLOAT(8),
  THRESHOLD2          FLOAT(8),
  THRESHOLD1SIGN      INTEGER,
  THRESHOLD2SIGN      INTEGER,
  CONSTRAINT XPKSBI_GOAL_KPI PRIMARY KEY (GOAL_KPI_ID)
) WITHOUT OIDS;

			
			
ALTER TABLE SBI_GOAL ADD FOREIGN KEY ( GRANT_ID ) REFERENCES SBI_ORG_UNIT_HIERARCHIES ( ID ) ON DELETE CASCADE;
ALTER TABLE SBI_GOAL_HIERARCHY ADD FOREIGN KEY (GOAL_ID) REFERENCES SBI_GOAL (GOAL_ID) ON DELETE CASCADE;
ALTER TABLE SBI_GOAL_HIERARCHY ADD FOREIGN KEY (PARENT_ID) REFERENCES SBI_GOAL_HIERARCHY (GOAL_HIERARCHY_ID) ON DELETE CASCADE;
ALTER TABLE SBI_GOAL_KPI ADD FOREIGN KEY (GOAL_HIERARCHY_ID) REFERENCES SBI_GOAL_HIERARCHY (GOAL_HIERARCHY_ID)  ON DELETE CASCADE;
ALTER TABLE SBI_GOAL_KPI ADD FOREIGN KEY (KPI_INSTANCE_ID) REFERENCES SBI_KPI_MODEL_INST (KPI_MODEL_INST) ON DELETE CASCADE;
--Chiara
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('groovy','Groovy','SCRIPT_TYPE','Script Type','Script Type');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('rhino-nonjdk','Javascript','SCRIPT_TYPE','Script Type','Script Type');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('ejs','Embedded Javascript','SCRIPT_TYPE','Script Type','Script Type');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('File','SbiFileDataSet','DATA_SET_TYPE','Data Set Type','SbiFileDataSet');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Query','SbiQueryDataSet','DATA_SET_TYPE','Data Set Type','SbiQueryDataSet');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Java Class','SbiJClassDataSet','DATA_SET_TYPE','Data Set Type','SbiJClassDataSet');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Web Service','SbiWSDataSet','DATA_SET_TYPE','Data Set Type','SbiWSDataSet');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Script','SbiScriptDataSet','DATA_SET_TYPE','Data Set Type','SbiScriptDataSet');
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Qbe','SbiQbeDataSet','DATA_SET_TYPE','Data Set Type','SbiQbeDataSet');

CREATE SEQUENCE SBI_DS_HISTORY_SEQ INCREMENT 1 START  1 ;
CREATE TABLE SBI_DATA_SET_HISTORY (
	DS_H_ID 	   INTEGER DEFAULT nextval('SBI_DS_HISTORY_SEQ') NOT NULL,
	DS_ID 		   INTEGER NOT NULL,
	ACTIVE		   BOOLEAN NOT NULL,
	VERSION_NUM	   INTEGER NOT NULL,
	OBJECT_TYPE    VARCHAR(50),
	DS_METADATA    VARCHAR(2000),
	PARAMS         VARCHAR(1000),
	CATEGORY_ID    INTEGER,
    FILE_NAME	   VARCHAR(300),
    QUERY   	   TEXT,
    DATA_SOURCE_ID INTEGER,
    ADRESS   	   VARCHAR(250),
    OPERATION      VARCHAR(50),
    JCLASS_NAME    VARCHAR(100),
    LANGUAGE_SCRIPT VARCHAR(50),
	SCRIPT   	   TEXT,
	JSON_QUERY     TEXT,
	DATAMARTS	   VARCHAR(400),
    TRANSFORMER_ID INTEGER,
    PIVOT_COLUMN   VARCHAR(50),
	PIVOT_ROW      VARCHAR(50),
	PIVOT_VALUE    VARCHAR(50),
	NUM_ROWS	   BOOLEAN DEFAULT FALSE,	
	USER_IN              VARCHAR(100) NOT NULL,
	TIME_IN              TIMESTAMP without time zone NOT NULL,
	META_VERSION         VARCHAR(100),
	SBI_VERSION_IN       VARCHAR(10),
    PRIMARY KEY (DS_H_ID)
)TYPE=INNODB;

ALTER TABLE SBI_DATA_SET_HISTORY ADD FOREIGN KEY FK_SBI_DATA_SET_T ( TRANSFORMER_ID ) REFERENCES SBI_DOMAINS ( VALUE_ID ) ON DELETE CASCADE;
ALTER TABLE SBI_DATA_SET_HISTORY ADD FOREIGN KEY FK_SBI_DATA_SET_CAT (CATEGORY_ID) REFERENCES SBI_DOMAINS (VALUE_ID) ON DELETE CASCADE ON UPDATE RESTRICT;
ALTER TABLE SBI_DATA_SET_HISTORY ADD FOREIGN KEY FK_SBI_DATA_SET_DS ( DATA_SOURCE_ID ) REFERENCES SBI_DATA_SOURCE ( DS_ID ) ON DELETE CASCADE;
ALTER TABLE SBI_DATA_SET_HISTORY ADD FOREIGN KEY FK_SBI_DATA_SET_DS2 (DS_ID) REFERENCES SBI_DATA_SET (DS_ID) ON DELETE CASCADE ON UPDATE RESTRICT;

INSERT INTO SBI_DATA_SET_HISTORY
(DS_ID,ACTIVE,VERSION_NUM,FILE_NAME,QUERY,JCLASS_NAME,SCRIPT,PARAMS,DS_METADATA
	,DATA_SOURCE_ID,OBJECT_TYPE,OPERATION,TRANSFORMER_ID,PIVOT_COLUMN,PIVOT_ROW
	,PIVOT_VALUE,NUM_ROWS,LANGUAGE_SCRIPT,USER_IN, TIME_IN)
SELECT DS_ID,true ACTIVE,1 VERSION_NUM,FILE_NAME,QUERY,JCLASS_NAME,SCRIPT,PARAMS,DS_METADATA,DATA_SOURCE_ID
,OBJECT_TYPE,OPERATION,TRANSFORMER_ID,PIVOT_COLUMN,PIVOT_ROW,PIVOT_VALUE,NUM_ROWS,LANGUAGE_SCRIPT
,'biadmin' USER_IN, now() TIME_IN
FROM SBI_DATA_SET;

commit;

--Drop all SBI_DATA_SET foreign keys
ALTER TABLE SBI_DATA_SET DROP FOREIGN KEY FK_SBI_DATA_SET_1;

ALTER TABLE SBI_DATA_SET DROP COLUMN EXECUTOR_CLASS;
ALTER TABLE SBI_DATA_SET DROP COLUMN FILE_NAME;
ALTER TABLE SBI_DATA_SET DROP COLUMN QUERY;
ALTER TABLE SBI_DATA_SET DROP COLUMN JCLASS_NAME;
ALTER TABLE SBI_DATA_SET DROP COLUMN SCRIPT;
ALTER TABLE SBI_DATA_SET DROP COLUMN PARAMS;
ALTER TABLE SBI_DATA_SET DROP COLUMN DS_METADATA;
ALTER TABLE SBI_DATA_SET DROP COLUMN DATA_SOURCE_ID;
ALTER TABLE SBI_DATA_SET DROP COLUMN OBJECT_TYPE;
ALTER TABLE SBI_DATA_SET DROP COLUMN OPERATION;
ALTER TABLE SBI_DATA_SET DROP COLUMN TRANSFORMER_ID;
ALTER TABLE SBI_DATA_SET DROP COLUMN PIVOT_COLUMN;
ALTER TABLE SBI_DATA_SET DROP COLUMN PIVOT_ROW;
ALTER TABLE SBI_DATA_SET DROP COLUMN PIVOT_VALUE;
ALTER TABLE SBI_DATA_SET DROP COLUMN NUM_ROWS;
ALTER TABLE SBI_DATA_SET DROP COLUMN LANGUAGE_SCRIPT;
ALTER TABLE SBI_DATA_SET DROP COLUMN ADRESS;

ALTER TABLE SBI_DATA_SET ADD COLUMN USER_IN VARCHAR(100) NOT NULL;
ALTER TABLE SBI_DATA_SET ADD COLUMN USER_UP VARCHAR(100); 
ALTER TABLE SBI_DATA_SET ADD COLUMN USER_DE VARCHAR(100);
ALTER TABLE SBI_DATA_SET ADD COLUMN TIME_IN TIMESTAMP without time zone NOT NULL;
ALTER TABLE SBI_DATA_SET ADD COLUMN TIME_UP TIMESTAMP without time zone NULL DEFAULT NULL;
ALTER TABLE SBI_DATA_SET ADD COLUMN TIME_DE TIMESTAMP without time zone NULL DEFAULT NULL;
ALTER TABLE SBI_DATA_SET ADD COLUMN SBI_VERSION_IN VARCHAR(10); 
ALTER TABLE SBI_DATA_SET ADD COLUMN SBI_VERSION_UP VARCHAR(10); 
ALTER TABLE SBI_DATA_SET ADD COLUMN SBI_VERSION_DE VARCHAR(10); 
ALTER TABLE SBI_DATA_SET ADD COLUMN META_VERSION VARCHAR(100); 
ALTER TABLE SBI_DATA_SET ADD COLUMN ORGANIZATION VARCHAR(20); 

UPDATE SBI_DATA_SET SET USER_IN = 'biadmin';

--Davide 12/04/2011
delete from SBI_DOMAINS WHERE VALUE_CD = 'Qbe' AND DOMAIN_CD = 'DATA_SET_TYPE';
INSERT into SBI_DOMAINS (VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS) values ('Qbe','SbiQbeDataSet','DATA_SET_TYPE','Data Set Type','SbiQbeDataSet');

ALTER TABLE SBI_DATA_SET_HISTORY ADD COLUMN DATAMARTS VARCHAR(400); 

--Monia 30/05/2011
ALTER TABLE SBI_CONFIG ADD COLUMN CATEGORY VARCHAR( 50 ) NULL 

--Monica 11/07/2011
ALTER TABLE SBI_ORG_UNIT_GRANT ADD COLUMN IS_AVAILABLE INTEGER DEFAULT 1;


------------- FROM 3.1 -------------
--Giulio 27/07/2011

CREATE TABLE SBI_OBJ_PARVIEW (
  OBJ_PAR_ID INTEGER NOT NULL,
   OBJ_PAR_FATHER_ID  INTEGER NOT NULL,
   OPERATION  VARCHAR(20) NOT NULL,
   COMPARE_VALUE  VARCHAR(200) NOT NULL,
   VIEW_LABEL  VARCHAR(50),
   PROG INTEGER,
          USER_IN              VARCHAR(100) NOT NULL,
       USER_UP              VARCHAR(100),
       USER_DE              VARCHAR(100),
       TIME_IN              TIMESTAMP NOT NULL,
       TIME_UP              TIMESTAMP NULL DEFAULT NULL,
       TIME_DE              TIMESTAMP NULL DEFAULT NULL,
       SBI_VERSION_IN       VARCHAR(10),
       SBI_VERSION_UP       VARCHAR(10),
       SBI_VERSION_DE       VARCHAR(10),
       META_VERSION         VARCHAR(100),
       ORGANIZATION         VARCHAR(20),    
  PRIMARY KEY ( OBJ_PAR_ID ,  OBJ_PAR_FATHER_ID ,  OPERATION, COMPARE_VALUE )
);


ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT FK_SBI_OBJ_PARVIEW_1 FOREIGN KEY ( OBJ_PAR_ID ) REFERENCES SBI_OBJ_PAR ( OBJ_PAR_ID ) ON DELETE RESTRICT;
ALTER TABLE SBI_OBJ_PARVIEW ADD CONSTRAINT FK_SBI_OBJ_PARVIEW_2 FOREIGN KEY ( OBJ_PAR_FATHER_ID ) REFERENCES SBI_OBJ_PAR ( OBJ_PAR_ID ) ON DELETE RESTRICT;

-- Change after 3.1  14/9/2011 Giulio

ALTER TABLE sbi_data_set_history ADD COLUMN CUSTOM_DATA TEXT AFTER DATAMARTS;

INSERT INTO SBI_DOMAINS (VALUE_ID, VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS, USER_IN)
VALUES ((SELECT next_val FROM hibernate_sequences WHERE sequence_name = 'SBI_DOMAINS'),
	'Custom','SbiCustomDataSet','DATA_SET_TYPE','Data Set Type','SbiCustomDataSet', 'biadmin');
	
	
-- 6/10/2011 Giulio
ALTER TABLE sbi_data_set_history MODIFY COLUMN DS_METADATA TEXT;


-- 20/10/2011 Davide : il motore worksheet può lavorare con i dataset
UPDATE SBI_ENGINES SET USE_DATASET = TRUE WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.worksheet.WorksheetDriver';


-- 06/12/2011 Davide : exporter XLSX per Qbe e Worksheet
INSERT INTO SBI_DOMAINS (VALUE_ID,VALUE_CD,VALUE_NM,DOMAIN_CD,DOMAIN_NM,VALUE_DS,USER_IN)
	VALUES ((SELECT next_val FROM hibernate_sequences WHERE sequence_name = 'SBI_DOMAINS'),	
	'XLSX','XLSX','EXPORT_TYPE','Exporters type','Export type', 'biadmin');
update hibernate_sequences set next_val = next_val+1 where sequence_name = 'SBI_DOMAINS';
commit;
INSERT INTO SBI_EXPORTERS (ENGINE_ID,DOMAIN_ID,DEFAULT_VALUE) 
	VALUES ((SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.worksheet.WorksheetDriver'),
	(SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'EXPORT_TYPE' AND VALUE_CD = 'XLSX'), 
	false);
commit;
INSERT INTO SBI_EXPORTERS (ENGINE_ID,DOMAIN_ID,DEFAULT_VALUE) 
	VALUES ((SELECT ENGINE_ID FROM SBI_ENGINES WHERE DRIVER_NM = 'it.eng.spagobi.engines.drivers.qbe.QbeDriver'),
	(SELECT VALUE_ID FROM SBI_DOMAINS WHERE DOMAIN_CD = 'EXPORT_TYPE' AND VALUE_CD = 'XLSX'), 
	false);
commit;